{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Sports Hub</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-gray-50 w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Product Management</h1>
      <p class="text-gray-600">Manage your products with AJAX — fast and seamless!</p>
    </div>

    <!-- Filter + Last Login + Refresh -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between bg-white rounded-lg border border-gray-200 p-4 mb-8">
      <div class="flex space-x-3">
        <button id="filter-all" class="filter-btn bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-700">
          All Products
        </button>
        <button id="filter-my" class="filter-btn bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white">
          My Products
        </button>
      </div>

      <div class="flex items-center gap-3 mt-4 sm:mt-0">
        {% if user.is_authenticated %}
          <div class="text-sm text-gray-500">Last login: <span class="font-medium text-gray-700">{{ last_login }}</span></div>
        {% endif %}
        <button id="refresh-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md font-medium text-sm flex items-center gap-1">
          Refresh
        </button>
        <button id="add-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium">
          + Add Product
        </button>
      </div>
    </div>

    <!-- States -->
    <div id="loading" class="hidden text-center text-gray-500 py-8">Loading products...</div>
    <div id="error" class="hidden text-center text-red-600 py-8">Failed to load products.</div>
    <div id="empty" class="hidden bg-white rounded-lg border border-gray-200 p-12 text-center">
      <img src="{% static 'image/no-product.png' %}" class="w-32 mx-auto mb-4">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">No products yet</h3>
      <p class="text-gray-500 mb-6">Be the first to add your Products.</p>
      <button id="empty-add" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">Add Product</button>
    </div>

    <!-- Product Grid -->
    <div id="grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="hidden fixed top-6 left-1/2 -translate-x-1/2 bg-green-600 text-white px-5 py-3 rounded-md shadow-md z-50 transition-all duration-500"></div>

<!-- Modal Create/Edit -->
<div id="modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <h2 id="modal-title" class="text-xl font-semibold text-gray-900">Add Product</h2>
      <button id="modal-close" class="text-gray-400 hover:text-gray-600">✕</button>
    </div>
    <form id="product-form" class="space-y-3">
      <input type="hidden" id="product-id">
      <input id="name" placeholder="Name" class="w-full border border-gray-300 p-2 rounded-md" required>
      <input id="price" type="number" placeholder="Price" class="w-full border border-gray-300 p-2 rounded-md" required>
      <input id="category" placeholder="Category" class="w-full border border-gray-300 p-2 rounded-md">
      <input id="thumbnail" placeholder="Thumbnail URL" class="w-full border border-gray-300 p-2 rounded-md">
      <textarea id="description" placeholder="Description" class="w-full border border-gray-300 p-2 rounded-md"></textarea>
      <label class="flex items-center gap-2">
        <input type="checkbox" id="featured" class="h-4 w-4">
        <span class="text-sm text-gray-600">Mark as featured</span>
      </label>
      <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
        <button type="button" id="cancel-btn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Modal -->
<div id="delete-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-lg">
    <h3 class="text-lg font-semibold mb-2">Delete Product?</h3>
    <p class="text-gray-500 mb-5">This action cannot be undone.</p>
    <div class="flex justify-center gap-3">
      <button id="delete-cancel" class="px-4 py-2 border rounded-md">Cancel</button>
      <button id="delete-confirm" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md">Delete</button>
    </div>
  </div>
</div>

<script>
const API = {
  list: "{% url 'main:show_json' %}",
  create: "{% url 'main:create_product_ajax' %}",
  update: id => `{% url 'main:update_product_ajax' '00000000-0000-0000-0000-000000000000' %}`.replace("00000000-0000-0000-0000-000000000000", id),
  delete: id => `{% url 'main:delete_product_ajax' '00000000-0000-0000-0000-000000000000' %}`.replace("00000000-0000-0000-0000-000000000000", id)
};

const CURRENT_USER_ID = "{{ user.username|default_if_none:'' }}";
let products = [];
let filter = "all";
let editId = null;
let deleteId = null;

const inputName = document.getElementById("name");
const inputPrice = document.getElementById("price");
const inputCategory = document.getElementById("category");
const inputThumbnail = document.getElementById("thumbnail");
const inputDescription = document.getElementById("description");
const inputFeatured = document.getElementById("featured");

const grid = document.getElementById('grid');
const loading = document.getElementById('loading');
const errorDiv = document.getElementById('error');
const empty = document.getElementById('empty');
const toast = document.getElementById('toast');
const modal = document.getElementById('modal');
const deleteModal = document.getElementById('delete-modal');

function showToast(msg, color="bg-green-600") {
  toast.textContent = msg;
  toast.className = `fixed top-6 left-1/2 -translate-x-1/2 text-white px-5 py-3 rounded-md shadow-md z-50 ${color}`;
  toast.classList.remove("hidden");
  setTimeout(() => toast.classList.add("hidden"), 2500);
}

function toggle({ gridShow=false, loadingShow=false, errorShow=false, emptyShow=false }) {
  grid.classList.toggle('hidden', !gridShow);
  loading.classList.toggle('hidden', !loadingShow);
  errorDiv.classList.toggle('hidden', !errorShow);
  empty.classList.toggle('hidden', !emptyShow);
}

async function fetchProducts() {
  toggle({loadingShow:true});
  try {
    const res = await fetch(API.list);
    if (!res.ok) throw new Error();
    const data = await res.json();
    products = data;
    renderProducts();
  } catch { toggle({errorShow:true}); }
}

function renderProducts() {
  const filtered = filter === 'my' ? products.filter(p => p.user_id == CURRENT_USER_ID) : products;
  if (filtered.length === 0) return toggle({emptyShow:true});
  grid.innerHTML = '';
  toggle({gridShow:true});
  filtered.forEach(p => {
    const card = document.createElement('div');
    card.className = "bg-white border border-gray-200 rounded-lg overflow-hidden flex flex-col cursor-pointer transition transform hover:scale-[1.02] hover:shadow-md";
    card.innerHTML = `
      <div class="aspect-[16/9] bg-gray-100">
        ${p.thumbnail ? `<img src="${p.thumbnail}" class="w-full h-full object-cover">` : ''}
      </div>
      <div class="p-5 flex flex-col flex-1">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">${p.name}</h3>
        <p class="text-gray-600 text-sm mb-2">${p.description}</p>
        <p class="text-gray-800 font-semibold mb-3">Rp ${p.price}</p>
        <div class="mt-auto flex justify-between z-10">
          <button data-id="${p.id}" data-action="edit" class="text-blue-600 hover:underline z-20">Edit</button>
          <button data-id="${p.id}" data-action="delete" class="text-red-600 hover:underline z-20">Delete</button>
        </div>
      </div>`;

    card.addEventListener("click", (e) => {
      const isButton = e.target.closest("button");
      if (isButton) return; 
      window.location.href = `/product/${p.id}/`;
    });

    grid.appendChild(card);

  });
}

// Filter Buttons
document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    filter = btn.id === "filter-my" ? "my" : "all";
    document.querySelectorAll(".filter-btn").forEach(b => {
      b.classList.remove("bg-green-600", "text-white");
      b.classList.add("bg-white", "text-gray-700");
    });
    btn.classList.add("bg-green-600", "text-white");
    renderProducts();
  });
});

// Refresh
document.getElementById("refresh-btn").addEventListener("click", () => {
  showToast("Refreshing...");
  fetchProducts();
});

// Modal logic
function openModal(p=null) {
  modal.classList.remove("hidden");
  document.getElementById("product-form").reset();
  editId = p ? p.id : null;
  document.getElementById("modal-title").textContent = editId ? "Edit Product" : "Add Product";
  if (p) {
    inputName.value = p.name;
    inputPrice.value = p.price;
    inputCategory.value = p.category;
    inputThumbnail.value = p.thumbnail;
    inputDescription.value = p.description;
    inputFeatured.checked = p.is_featured;
  }

}
function closeModal() { modal.classList.add("hidden"); }
document.getElementById("modal-close").onclick = closeModal;
document.getElementById("cancel-btn").onclick = closeModal;
document.getElementById("add-btn").onclick = () => openModal();
document.getElementById("empty-add").onclick = () => openModal();

document.getElementById("product-form").onsubmit = async e => {
  e.preventDefault();
  const formData = new FormData();
  formData.append("name", inputName.value);
  formData.append("price", inputPrice.value);
  formData.append("category", inputCategory.value);
  formData.append("thumbnail", inputThumbnail.value);
  formData.append("description", inputDescription.value);
  if (inputFeatured.checked) formData.append("is_featured", "on");
  const url = editId ? API.update(editId) : API.create;

  try {
    const res = await fetch(url, {
      method: "POST",
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": csrftoken,
      },
    });
    const data = await res.json();
    if (!data.success) throw new Error();
    showToast(editId ? "Product updated!" : "Product added!");
    closeModal();

    if (editId) {
      const idx = products.findIndex(p => p.id === editId);
      if (idx !== -1) products[idx] = data.product;
    } else {
      products.push(data.product);
    }

    renderProducts();
  } catch (err) {
    console.error(err);
    showToast("Failed to save", "bg-red-600");
  }
};



// Delete
grid.onclick = e => {
  const btn = e.target.closest("button");
  if (!btn) return;
  const id = btn.dataset.id;
  const act = btn.dataset.action;
  const product = products.find(p => p.id == id);
  if (act === "edit") openModal(product);
  if (act === "delete") {
    deleteId = id;
    deleteModal.classList.remove("hidden");
  }
};
document.getElementById("delete-cancel").onclick = () => deleteModal.classList.add("hidden");
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie("csrftoken");

document.getElementById("delete-confirm").onclick = async () => {
  try {
    const formData = new FormData();
    formData.append("_method", "DELETE");
    const res = await fetch(API.delete(deleteId), {
      method: "POST",
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": csrftoken,
      }
    });
    const data = await res.json();
    if (!data.success) throw new Error();
    showToast("Deleted!");
    deleteModal.classList.add("hidden");
    fetchProducts();
  } catch (err) {
    console.error(err);
    showToast("Delete failed", "bg-red-600");
  }
};



// Init
fetchProducts();
</script>
{% endblock content %}
